<script type="text/javascript">
  var network = null;
  var nodes = new vis.DataSet([{id: 1, label: "{{artifact_type}}", group: 'type'}]);
  var edges = new vis.DataSet();
  var commands = null;
  var current_node = null;

  function add_command() {
    var command_info = commands[$("#command").val()];
    //TODO: add job callback
    var command_node = nodes.length + 1;
    edges.add({ id: edges.length + 1, from: current_node, to: command_node});
    nodes.add({ id: command_node, label: command_info.command, group: 'command', command_id: command_info.id});
    for(i=0;i<command_info.output.length;i++) {
      var node_id = nodes.length + 1;
      edges.add({ id: edges.length + 1, from: command_node, to: node_id});
      nodes.add({ id: node_id, label: command_info.output[i], group: 'type', command_id: null});
    }
    network.redraw();
  }

  function remove_command(node_id) {
    //TODO: delete job callback
    var queue = [node_id];
    var edge_list = edges.get();
    while(queue.length !== 0) {
      var current = queue.pop();
      for(var i=0;i<edge_list.length;i++) {
        edge = edge_list[i];
        if(edge.from == current) {
          if($.inArray(edge.to, queue) == -1) { queue.push(edge.to); }
          edges.remove(edge.id);
        }
      }
      nodes.remove(current);
    }
    edges.remove(edges.get({ filter: function (item) { return item.to == node_id; } })[0].id);
    network.redraw();
  }

  function load_job(node_id) {
    current_node = node_id;
    $.get('/study/job/', {job_id: nodes.get(node_id).id})
      .done(function ( data ) {
        $("#network-info").empty();
        var button = $('<button>').appendTo('#network-info');
        button.addClass('btn btn-xs').text('Remove Command').click(function () { remove_command(nodes.get(node_id).id); });
        options = data.options;
        for(i=0;i<options.length;i++) {
          opt = options[i];
          // add each input to the form, based on the type given
          var input = $('<input>');
          input.attr('value', opt.value).attr('name', opt.name);
          if(opt.required) { input.attr('required', true); }

          switch(opt.type) {
            case 'integer': input.attr('type', 'number').attr('min', 0).attr('step', 1);
              break;
            case 'float': input.attr('type', 'number').attr('min', 0);
              break;
            case 'bool': input.attr('type', 'checkbox'); if(opt.value == true) { input.attr('checked', true) }
              break;
            case 'string': input.attr('type', 'text');
              break;
            default: input = null;
              break;
          }
          if(input != null) { $('<p>').text(opt.name).attr('id', opt.name).appendTo('#network-info'); input.appendTo('#' + opt.name); }
        }
        var button = $('<button>').appendTo('#network-info');
        button.addClass('btn btn-xs').text('Save Changes').click(save_options);
      });
  }

  function save_options() {

  }

  function load_filetype(node_id) {
    $.get('/study/commands/', {artifact_type: nodes.get(node_id).label})
      .done(function ( data ) {
        $("#network-info").empty();
        commands = data.commands;
        $("#network-info").html("<h4>Available Commands</h4>");
        var sel = $('<select>').appendTo('#network-info');
        sel.attr('id', 'command').attr('name', 'command');
        for(i=0;i<commands.length;i++) {
         sel.append($("<option>").attr('value',i).text(commands[i].command));
        }
        var select = $('<button>').appendTo('#network-info');
        select.addClass('btn btn-xs').text('Add Command').click(add_command);
        current_node = node_id;
      });
  }

  $(document).ready(function() {
    // create a network
    var container = document.getElementById('network');
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
      nodes: {
        color: {highlight: {border: "yellow"}},
        font: '14px arial black'
      },
      edges:{
        color: 'grey'
      },
      layout: {
        hierarchical: {
          direction: "LR",
          sortMethod: "directed",
          levelSeparation: 150
        }
      },
      interaction: {
        dragNodes: false,
        dragView: true,
        zoomView: true,
        selectConnectedEdges: false
      },
      groups: {
        type: {shape: "ellipse", color: "#cef"},
        command: {shape: "box", color: "#9fd"}
      }
    };
    network = new vis.Network(container, data, options);
    network.on('select', function(params) {
          //render the information for the selected artifact ID
          if(+params.nodes !== 0) {
            var node_info = nodes.get(+params.nodes);
            if(node_info.group == 'command') { load_job(+params.nodes) }
            else { load_filetype(+params.nodes); }
          }
        });
  });
</script>

<div id="network" style="width:100%;height:300px;border: 1px solid #ccc;"></div>
<div id="network-info" style="width:100%"></div>