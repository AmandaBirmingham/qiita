{%extends sitebase.html%}
{%block head%}
<script src="/static/js/analysis.js"></script>
<script type="text/javascript">

</script>
{%end%}

{%block content%}
{% from future.utils import viewitems %}
{% from qiita_db.study import Study %}
{% from qiita_db.data import ProcessedData %}
{% from qiita_pet.util import clean_str %}
{% module Template("search_studies_doc_modal.html", availmeta=availmeta) %}
 <form role="form" action="/analysis/search/studies/" id="results-form" method="post">
<!-- Build the selected data modals -->
{% for sid in selproc_data %}
        <div class="modal fade" id='selmodal{{sid}}'>
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title">Selected samples</h4>
              </div>
              <div class="modal-body">
        <p><a href="#" onclick="select_deselect('sel{{sid}}', true); return false;">Select all</a> | <a href="#" onclick="select_deselect('sel{{sid}}', false); return false;">Select none</a></p>
        {% for samp in selsamples[sid] %}
          <input type='checkbox' class='sel{{sid}}' name='sel{{sid}}' value='{{samp}}'> {{samp}}<br />
       {% end %}
     </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->
  {% end %}
<div id="availstudies" style="position: fixed;width: 100%;overflow : auto;">  <!-- Search results -->
<h1>Search</h1>
 <input type="hidden" name="action" id="action" value="">
<input type="hidden" name="analysis-id" value="{{aid}}">

<p><input type="text" name="query" id="query" style="width:80%;white-space:nowrap;"><input type="submit" class="btn btn-default" onclick="pre_submit('search')" value="Search"></p>
<p><a href="#" data-toggle="modal" data-target="#searchexample">Search examples</a> | <a href="#" data-toggle="modal" data-target="#availmeta">Metadata headers</a></p>
<div id='searchmsg' style="color:red;">{{searchmsg}}</div>


{% if results %}
  <big>   Overall counts for current search</big>
   <table class='table' style="width:50%">
    <tr><th>Metadata</th><th>Count</th><th></th></tr>
    {% for meta_cat, sub_cats in viewitems(fullcounts) %}
      <tr><td><strong>{{meta_cat}}</strong></td><td></td><td></td></tr>
      {% for sub_cat, count in viewitems(sub_cats) %}
        <tr><td>{{sub_cat}}</td><td>{{count}}</td>
        <td><a href='#' onclick="select_category('{{clean_str(sub_cat)}}', ''); return false;">Select category</a></td></tr>
      {% end %}
    {% end %}
  </table>
    <table class='table table-hover' style="width:100%">
      <tr><th>Data Types</th><th>Name</th><th>Description</th><th>Status</th></tr>
      {% for sid, samples in viewitems(results) %}
        {% set study = Study(sid) %}
        <tr id="study{{sid}}"><td>
        {% for data_type in study.data_types %}
          <input type='hidden' name='availstudies' id='{{sid}}#{{data_type}}' value='{{sid}}#{{data_type}}' disabled=true>
          <select name='{{sid}}#{{data_type}}' multiple=true onchange="enable_study_datatype('{{sid}}#{{data_type}}')" onclick="enable_study_datatype('{{sid}}#{{data_type}}')">
          {% for proc_data in study.processed_data(data_type=data_type) %}
            <option value="{{proc_data}}">{{proc_data}}</option>
          {% end %}
          </select>{{data_type}}<br />
          </td><td style='vertical-align:middle;'><a href="#" data-toggle="modal" data-target="#modal{{sid}}">{{study.title}}</a></td>
          <td style='vertical-align:middle;'>
          {{study.info["study_description"]}}</td>
          <td style='vertical-align:middle;'>{{study.status}}</td></tr>
        {% end %}
      {% end %}
    </table>
  </div>
  {% for sid, samples in viewitems(results) %}
    <div class="modal fade" id='modal{{sid}}'>
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Select samples</h4>
            </div>
            <div class="modal-body">
              <h3>Statistics</h3>
              <table class='table' style="width:50%">
                <tr><th>Metadata</th><th>Count</th><th></th></tr>
                {% for meta_cat, sub_cats in viewitems(counts[study.id]) %}
                  <tr><td><strong>{{meta_cat}}</strong></td><td></td><td></td></tr>
                  {% for sub_cat, count in viewitems(sub_cats) %}
                    <tr><td>{{sub_cat}}</td><td>{{count}}</td>
                    <td><a href='#' onclick="select_category('{{clean_str(sub_cat)}}', '{{sid}}'); return false;">Select category</a></td></tr>
                  {% end %}
                {% end %}
              </table>
              <h3>Samples</h3>
              <a href="#" onclick="select_deselect({{sid}}, true); return false;">Select all</a> | <a href="#" onclick="select_deselect({{sid}}, false); return false;">Select none</a>
              <table class='table table-hover'><td><th>Sample ID</th>
              {% for meta in meta_headers %}
                <th>{{meta}}</th>
              {% end %}
               </tr>
              {% for sample in samples %}
                <tr><td>
                <input type='checkbox' name='{{sid}}'
                value='{{sample[0]}}' class='{{sid}} {{ " ".join(clean_str(s) for s in sample[1:]) }}'>
                </td><td>{{sample[0]}}</td>
                {% for pos in range(len(meta_headers)) %}
                  <td>{{sample[pos+1]}}</td>
                {% end %}
              </tr>
              {% end %}
              </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->
  {% end %}
{% end %}

<div id="seperator" style="position:fixed;height:32px;width:100%;background:#ff2500;padding:5px;bottom:0px;"><input type="submit" class="btn btn-default btn-xs" onclick="pre_submit('select')" value="Select samples" style="vertical-align: middle;">
<input type="submit" class="btn btn-default btn-xs" onclick="pre_submit('deselect')" value="Remove samples">
<input type="submit" class="btn btn-default btn-xs" onclick="pre_submit('continue')" value="Continue"> <a href="#" onclick="displaySelected(); return false;" style="color:white;" id="shselected">Show selected samples</a>
</div>

<div id="selected" style="position:absolute;width: 100%;bottom: 0px; height:0px;overflow:auto;display:none;"> <!-- Selected samples -->
<big>    Selected Samples</big>
  <table class="table table-hover">
  {% for sid, proc_ids in viewitems(selproc_data) %}
    {% set study = Study(sid) %}
    <tr><td>
    {% for proc in proc_ids %}
      {% set data_type = ProcessedData(proc).data_type() %}
      <input type='hidden' name='selstudies' value='{{sid}}'> <input type='checkbox' name='dt{{sid}}' value='{{proc}}'>{{data_type}} - {{proc}} <br />
      {% end %}
    </td><td><a href="#" data-toggle="modal" data-target="#selmodal{{sid}}">{{study.title}}</a></td><td>{{study.info["study_description"]}}</td></tr>
  {%end%}
  </table>
</div>
</form>
{%end%}