{%extends sitebase.html%}
{%block head%}
<script type='text/javascript'>
function toggle_row(sid) {
  if(navigator.appName.indexOf("Microsoft") > -1){var canSee = 'block';} 
  else {var canSee = 'table-row';}
  row_style = document.getElementById("row" + sid).style;
  if(row_style.display == "none") {
    row_style.display = '';
    document.getElementById('toggle' + sid).innerHTML = "(-)";
  }
  else {
    row_style.display = "none";
    document.getElementById('toggle' + sid).innerHTML = "(+)";
  }
}
</script>
{%end%}

{%block content%}
{% from future.utils import viewitems %}
{% from qiita_db.study import Study %}
{% from qiita_db.data import ProcessedData %}
<h1>Search</h1>
 <form role="form" action="/analysis/search/studies/" id="results-form" method="post">
 <input type="hidden" name="action" value="">
<input type="hidden" name="analysis-id" value="{{aid}}">

<input type="text" name="query" id="query" style="width:80%;white-space:nowrap;"><input type="submit" class="btn btn-default" value="Search">

<h1>Studies</h1>
<big>   Select studies to analyze</big>
<div id="availstudies">  <!-- Search results -->
  <table class='table table-hover'>
    <tr><th>Data Types</th><th>Name</th><th>Description</th><th>Status</th></tr>
    {% for sid, samples in viewitems(results) %}
      {% set study = Study(sid) %}
      <tr id="study{{sid}}"><td>
      {% for data_type in study.data_types %}
        <input type='checkbox' name='availstudies' value='{{sid}}#{{data_type}}'>
        <select name='{{sid}}#{{data_type}}'>
        <option value="">{{data_type}}</option>
        {% for proc_data in study.processed_data(data_type=data_type) %}
          <option value="{{proc_data}}">{{proc_data}}</option>
        {% end %}
        <br />
        </td><td style='vertical-align:middle;'><a href="#" id="toggle{{sid}}" onclick="toggle_row('{{sid}}'); return false;">(+)</a> {{study.title}}</td>
        <td style='vertical-align:middle;'>
        {{study.info["study_description"]}}</td>
        <td style='vertical-align:middle;'>{{study.status}}</td></tr>
      {% end %}
      <tr id='row{{sid}}' style="display:none;"><td colspan=4><h3>Statistics</h3>
      <table class='table'>
        <tr><th>Metadata</th><th>Count</th><th></th></tr>
        {% for meta_cat, sub_cats in viewitems(counts[study.id]) %}
          <tr><td><strong>{{meta_cat}}</strong></td><td></td><td></td></tr>
          {% for sub_cat, count in viewitems(sub_cats) %}
            <tr><td>{{sub_cat}}</td><td>{{count}}</td>
            <td><a href='#'>Select category</a></td></tr>
          {% end %}
        {% end %}
      </table>
      <h3>Samples</h3>
      <table class='table table-hover'><td><th>Sample ID</th>
      {% for meta in meta_headers %}
        <th>{{meta}}</th>
      {% end %}
       </tr>
      {% for sample in samples %}
        <tr><td>
        <input type='checkbox' name='{{sid}}'
        value='{{sample[0]}}' class=''>
        </td><td>{{sample[0]}}</td>
        {% for pos in range(len(meta_headers)) %}
          <td>{{sample[pos+1]}}</td>
        {% end %}
      </tr>
      {% end %}
      </table>
      <a href="#" id="toggle{{sid}}" onclick="toggle_row('{{sid}}'); return false;">Collapse</a>
    {% end %}
  </table>
</div>
<p><input type="submit" class="btn btn-default" value="Select studies"></p>

<big>    Selected Studies</big>
<div id="selected"> <!-- Selected samples -->
  <table class="table table-hover">
  {% for study_id, proc_ids in viewitems(selproc_data) %}
    {% set study = Study(study_id) %}
    <tr><td>
    {% for proc in proc_ids %}
      {% set data_type = ProcessedData(proc).data_type %}
      <input type='checkbox' name='selstudies' value='{{sid}}#{{data_type}}' checked> {{data_type}} - {{proc}} <br />
      {% end %}
    </td><td>{{study.title}}</td><td>{{study.description}}</td></tr>
    <tr><td colspan=3>
    {% for samp in selsamples[study_id] %}
      <input type='checkbox' name='sel{{sid}}' value='{{samp}}' checked> {{samp}}<br />
     {% end %}
    </td></tr>
    {% end %}
  </table>
</div>
<input type="button" class="btn btn-default" value="De-select">
<input type="button" class="btn btn-default" value="Continue">
</form>
{%end%}