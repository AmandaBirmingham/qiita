{% extends sitebase.html %}
{% block head %}
<script>
// Note that these two callbacks can come from the step where you are creating
// a new prep template or when you are editing the prep template thus isEdit
function investigationTypeChanged(rawDataID, isEdit){

  // whether the callback comes from an edit element
  var isEdit = isEdit !== undefined ? isEdit : false;

  if (isEdit){
    if ($('#edit-investigation-type-'+rawDataID).val() === 'Other'){
      $('#edit-user-defined-investigation-types-'+rawDataID).show()
    }
    else {
      $('#edit-user-defined-investigation-types-'+rawDataID).hide()
      $('#edit-new-investigation-type-entry-'+rawDataID).hide()
    }
  }
    else{
    if ($('#investigation-type-'+rawDataID).val() === 'Other'){
      $('#user-defined-investigation-types-'+rawDataID).show()
    }
    else {
      $('#user-defined-investigation-types-'+rawDataID).hide()
      $('#new-investigation-type-entry-'+rawDataID).hide()
    }
  }
}
function newInvestigationTypeChanged(rawDataID, isEdit){

  // whether the callback comes from an edit element
  var isEdit = isEdit !== undefined ? isEdit : false;

  if (isEdit){
    if ($('#edit-user-defined-investigation-type-'+rawDataID).val() === 'New Type'){
      $('#edit-new-investigation-type-entry-'+rawDataID).show()
    }
    else {
      $('#edit-new-investigation-type-entry-'+rawDataID).hide()
    }
  }
  else{
    if ($('#user-defined-investigation-type-'+rawDataID).val() === 'New Type'){
      $('#new-investigation-type-entry-'+rawDataID).show()
    }
    else {
      $('#new-investigation-type-entry-'+rawDataID).hide()
    }
  }
}
</script>
{% end %}


{% block content %}


<table border="0" style="vertical-align: middle; text-align:center; align:center;">
  <tr>
    <td style="vertical-align: middle; text-align:left; width: 50%;" colspan="2">
      <h1>{{study_title}} </h1>
      <h2><i>{{study_alias}}</i></h2>
    </td>
  </tr>
  <tr>
    <td style="vertical-align: middle; text-align:left; width: 50%;" colspan="2">
      {% if show_edit_btn %}
        <a class="btn btn-default glyphicon glyphicon-edit" href="/study/edit/{{study.id}}" title="Edit the study information" style="margin:5px; word-spacing: -10px;"> Edit</a>
      {% end %}
      {% if show_upload_btn %}
        <a href="/study/upload/{{study.id}}" class="btn btn-default glyphicon glyphicon-upload" title="Upload study files" style="margin:5px; word-spacing: -10px;"> Upload</a>
      {% end %}
      {% if btn_to_show == 'request_approval' %}
        <a class="btn btn-default glyphicon glyphicon-eye-open" onClick="request_approval();" style="margin:5px; word-spacing: -10px;"> Request Approval</a>
      {% elif btn_to_show == 'approve_study' %}
        <a class="btn btn-success glyphicon glyphicon-thumbs-up" onClick="approve_study();" style="margin:5px; word-spacing: -10px;"> Approve Study</a>
      {% elif btn_to_show == 'make_public' %}
       <a class="btn btn-success glyphicon glyphicon-thumbs-up" onClick="make_public();" style="margin:5px; word-spacing: -10px;"> Make Public</a>
      {% end %}
      {% if show_revert_btn %}
        <a class="btn btn-default glyphicon glyphicon-backward" onClick="make_sandbox();" style="margin:5px; word-spacing: -10px;"> Revert to sandbox</a>
      {% end %}
    </td>
  </tr>
</table>

<br/>

<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist" id="myTab">
    <li class="active"><a href="#study_information_tab" role="tab" data-toggle="tab">Study information</a></li>
    <li><a href="#sample_template_tab" role="tab" data-toggle="tab">Sample template</a></li>
  {% if show_data_tabs %}
    <li><a href="#raw_data_tab" role="tab" data-toggle="tab">Raw data</a></li>
    <li><a href="#preprocessed_data_tab" role="tab" data-toggle="tab">Preprocessed data</a></li>
  {% end %}
</ul>

<!-- Tab panes -->
<div class="tab-content">
  <!-- Show the study information tab -->
  {% module StudyInformationTab(study) %}
  <!-- Show the sample template tab -->
  {% module SampleTemplateTab(study) %}  
  {% if show_data_tabs %}
    <!-- Show the raw data tab -->
    {% module RawDataTab(study) %}
    <!-- Show the preprocessed data tab -->
    {% module PreprocessedDataTab(study) %}
  {% end %}
</div>

<script type='text/javascript'>

  $(document).ready(function() {
        $("#previous_raw_data").chosen({width: "100%"});
  });

  function process_sample_template() {
    if (confirm("Are you sure you want to (re)process the sample template?")) {
      var form = $("<form>")
        .attr("action", window.location.href)
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "sample_template")
          .attr("value", $("#sample_template").val()));
      $("body").append(form);
      form.submit();
    }
  }

  function create_raw_data() {
    if ($("#previous_raw_data").val() === null && $("#filetype").val() === "") {
      alert("You need to select either a new file type or a raw data used in a previous study.");
    } else if ((typeof $("#previous_raw_data").val() != 'undefined' && $("#previous_raw_data").val() !== null) && $("#filetype").val() !== "") {
      alert("You can only select a new file type or one used in a previous study but not both.");
    } else {
      if (confirm("Are you sure you want to create a new raw data?")) {
        if ($("#filetype").val() !== "") {
          var form = $("<form>")
            .attr("action", window.location.href)
            .attr("method", "post")
            .append($("<input>")
              .attr("type", "hidden")
              .attr("name", "filetype")
              .attr("value", $("#filetype").val()));
        } else {
          var form = $("<form>")
            .attr("action", window.location.href)
            .attr("method", "post")
            .append($("<input>")
              .attr("type", "hidden")
              .attr("name", "previous_raw_data")
              .attr("value", $("#previous_raw_data option:selected").map(function(){ return this.value }).get().join(",")));
        }
        $("body").append(form);
        form.submit();
      }
    }
  }

  function add_prep_template(raw_data_id) {
    if (confirm("Are you sure you want to add a new prep template?")) {
      var form = $("<form>")
        .attr("action", window.location.href)
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "raw_data_id")
          .attr("value", raw_data_id))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "add_prep_template")
          .attr("value", $("#add_prep_template_" + raw_data_id).val()))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "investigation-type")
          .attr("value", $("#investigation-type-" + raw_data_id).val()))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "user-defined-investigation-type")
          .attr("value", $("#user-defined-investigation-type-" + raw_data_id).val()))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "new-investigation-type")
          .attr("value", $("#new-investigation-type-" + raw_data_id).val()))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "data_type_id")
          .attr("value", $("#data_type_" + raw_data_id).val()));
      $("body").append(form);
      form.submit();
    }
  }

  function link_files_to_raw_data(raw_data_id) {
    var barcodes = [];
    var forward = [];
    var reverse = [];

    all_files = document.getElementsByName("upload_file_" + raw_data_id);
    for (var i = 0; i<all_files.length; i++) {
      ele = all_files[i];
      switch (ele.options[ele.selectedIndex].value) {
        case "barcodes":
          barcodes.push(ele.id);
          break;
        case "forward seqs":
          forward.push(ele.id);
          break;
        case "reverse seqs":
          reverse.push(ele.id);
          break;
      }
    }

    if (barcodes.length === 0 || forward.length === 0) {
      alert("You need to select at least one barcode and one forward file.");
    } else if (barcodes.length != forward.length) {
      alert("You must select the same number of barcode and forward seq files.");
    } else if (reverse.length !== 0 && reverse.length != forward.length) {
      alert("If you select reverse seqs, they should have the same number than barcodes and forward files.");
    } else {
      var form = $("<form>")
        .attr("action", "/study/add_files_to_raw_data")
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "raw_data_id")
          .attr("value", raw_data_id))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "study_id")
          .attr("value", {{study.id}}))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "barcodes")
          .attr("value", barcodes.join()))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "forward")
          .attr("value", forward.join()))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "reverse")
          .attr("value", reverse.join()));
      $("body").append(form);
      form.submit();
    }
  }

  function unlink_all_files(raw_data_id) {
    if (confirm("Are you sure you want to unlink all files? They will be removed from the system")){
      var form = $("<form>")
        .attr("action", "/study/unlink_all_files")
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "study_id")
          .attr("value", {{study.id}}))
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "raw_data_id")
          .attr("value", raw_data_id))
      $("body").append(form);
      form.submit();
    }
  }

  function make_public() {
    if (confirm("Are you sure you want to make this study public?")) {
      var form = $("<form>")
        .attr("action", window.location.href)
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "make_public")
          .attr("value", true))
      $("body").append(form);
      form.submit();
    }
  }

  function approve_study() {
    if (confirm("Are you sure you want to approve this study?")) {
      var form = $("<form>")
        .attr("action", window.location.href)
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "approve_study")
          .attr("value", true))
      $("body").append(form);
      form.submit();
    }
  }

  function request_approval() {
    if (confirm("Are you sure you want to ask for approval? IMPORTANT: This will not allow you to add any new raw data or modifications to this study")) {
      var form = $("<form>")
        .attr("action", window.location.href)
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "request_approval")
          .attr("value", true))
      $("body").append(form);
      form.submit();
    }
  }

  function make_sandbox() {
    if (confirm("Are you sure you want to revert to sandbox status?")) {
      var form = $("<form>")
        .attr("action", window.location.href)
        .attr("method", "post")
        .append($("<input>")
          .attr("type", "hidden")
          .attr("name", "make_sandbox")
          .attr("value", true))
      $("body").append(form);
      form.submit();
    }
  }

  function update_investigation_type(old_value, prep_template_id) {
    if (confirm("Are you sure you want to update the investigation type?")) {
        var form = $("<form>")
          .attr("action", window.location.href)
          .attr("method", "post")
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "update_investigation_type")
            .attr("value", prep_template_id))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "edit-user-defined-investigation-type")
            .attr("value", $("#edit-user-defined-investigation-type-" + prep_template_id).val()))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "edit-new-investigation-type")
            .attr("value", $("#edit-new-investigation-type-" + prep_template_id).val()))
          .append($("<input>")
            .attr("type", "hidden")
            .attr("name", "edit-investigation-type")
            .attr("value", $("#edit-investigation-type-" + prep_template_id).val()));
        $("body").append(form);
        form.submit();
    } else {
      $("#investigation_type_prep_" + prep_template_id).val(old_value);
    }
  }

  function submit_preprocess() {
    if (confirm("Are you sure you want to submit a preprocessing job?")){
      return true;
    }
    return  false;
  };

  function display_tab(top_tab, sub_tab, prep_tab){
    $('#myTab a[href="#'+top_tab+'"]').tab('show');
    if (top_tab == "raw_data_tab"){
      $('#raw_data_nav_tabs a[href="#raw_data_info_'+sub_tab+'"]').tab('show')
      if (prep_tab !== undefined){
        $('#collapse'+prep_tab).collapse()
      }
    }
    else if (top_tab == "preprocessed_data_tab"){
      $('#preprocessed_data_nav_tabs a[href="#preprocessed_data_info_'+sub_tab+'"]').tab('show')
    }
  }

  if ("{{tab_to_display}}" == "study_information_tab"){
    $('#myTab a[href="#study_information_tab"]').tab('show');
  }
  else if ("{{tab_to_display}}") {
    $('#myTab a[href="#raw_data_info_{{tab_to_display}}"]').tab('show');
  } else {
    $('#myTab a:last').tab('show');
  }

</script>
{% end %}
