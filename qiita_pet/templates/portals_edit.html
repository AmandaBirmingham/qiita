{% extends sitebase.html%}

{%block head%}
<link rel="stylesheet" href="/static/vendor/css/jquery.dataTables.css" type="text/css">
<style type="text/css">
  .navlist li
  {
    display: inline;
    padding-right: 20px;
  }
  .portal-select {
    width: 15em;
  }
</style>
<script src="/static/vendor/js/jquery.dataTables.min.js"></script>
<script type="text/javascript">
function check_submit(action) {
  //disable submit buttons
  $("#add-button").prop('disabled', true);
  $("#remove-button").prop('disabled', true);
  $("#messages").html("");
  var error = false;
  if($("#portal").val() === '') {
    //No selected portal, so add error message if needed and then don't submit
    if(!$('#portal-error').length) { $("#errors").append("<li id='portal-error'>Please select a portal</li>"); }
    error = true;
  }
  var boxes = oTable.$(".selected:checked", {"page": "all"});
  //serialize the checked boxes
  var data = "";
  for(i=0;i<boxes.length;i++) {
    data += "&selected="+boxes[i].value;
  }
  if(data.length === 0) {
    //No checked rows, so add error message if needed and then don't submit
    if(!$('#checkbox-error').length) { $("#errors").append("<li id='checkbox-error'>Please select at least one row</li>"); }
    error = true;
  }
  if(error) {
    $("#add-button").prop('disabled', false);
    $("#remove-button").prop('disabled', false);
    return false;
  }
  $('#action').val(action);
  data = $('#portal-form').serialize() + data;
  $.post('{{submit_url}}', data, function(data,textStatus,jqXHR){
    $("#add-button").prop('disabled', false);
    $("#remove-button").prop('disabled', false);
    $("#messages").html(data);
  });
}

function render_checkbox(data, type, full) {
  return "<input type='checkbox' class='selected' onclick='checkbox_change()' value='" + full['study_id'] + "' />";
}

function checkbox_change() {
  $("#checkbox-error").remove();
}

$(document).ready(function() {
  //https://github.com/DataTables/Plugins/blob/master/sorting/custom-data-source/dom-checkbox.js
  $.fn.dataTable.ext.order['dom-checkbox'] = function  ( settings, col ) {
      return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
          return $('input', td).prop('checked') ? '1' : '0';
      } );
  };

  oTable = $('#info-table').dataTable({
    "deferRender": true,
    "iDisplayLength": 50,
    "columns": [
      {"className": 'select', "data": null},
      {% for h in headers %}
      {"data": "{{h}}"},
      {% end %}
    ],
    'aoColumnDefs': [
      { 'mRender': render_checkbox, 'mData': 1, 'aTargets': [ 0 ] }
    ],
    "ajax": {
      "url": "/admin/portals/studiesAJAX/?sEcho=" + Math.floor(Math.random()*1001) + "&view-portal=QIITA",
      "aoColumns": [
        {"sSortDataType": "dom-checkbox", "bSearchable": false},
        {% for h in headers %}
        {"data": "{{h}}"},
        {% end %}
      ],
      "error": function(jqXHR, textStatus, ex) {
          $("#add-button").prop('disabled', true);
          $("#remove-button").prop('disabled', true);
          $("#errors").append("<li id='comm-error'>Internal Server Error, please try again later</li>");
      }
    }
  });

  $('#portal').change(function(){
        $("#portal-error").remove();
    });

  $('#view-portal').change(function() {
    var echo = "?sEcho=" + Math.floor(Math.random()*1001) + "&view-portal=" + $("#view-portal").val();
    $('#info-table').DataTable().ajax.url("/admin/portals/studiesAJAX/" + echo).load();
  });
});
</script>
{%end%}

{%block content%}
<div class="row topfloat">
  <div class='col-lg-12'>
    <span style="float:right"><b>View from portal:</b>
      <select name="view-portal" id="view-portal" class="portal-select">
        <option value="QIITA">QIITA</option>
        {% for portal in portals %}
        <option value="{{portal}}">{{portal}}</option>
        {% end %}
      </select>
    </span>
    <table>
      <tr><td style="white-space: nowrap;">
        <form role="form" id="portal-form">
        <b>Portal:</b> <select name="portal" id="portal" class="portal-select">
          <option value=""></option>
          {% for portal in portals %}
          <option value="{{portal}}">{{portal}}</option>
          {% end %}
        </select>
        <input type="hidden" name="action" id="action" value="">
        <input type="button" id="add-button" value="Add" class="btn btn-sm btn-success" onclick="check_submit('Add')"> <input type="button" id="remove-button" value="Remove" class="btn btn-sm btn-danger" onclick="check_submit('Remove')">
        </form>
        <span class="errorTxt" style="color:red">
          <ul id="errors" class="navlist"></ul>
        </span>
      </td><td style="padding-left:10px">
        <span id="messages"></span>
      </td></tr>
    </table>
  </div>
</div>
<div class='row' style="margin-top:50px">
  <div class='col-lg-12'>
    <table id="info-table" class="table">
    <thead>
      <tr>
        <td>Select</td>
        {% for head in headers %}
        <td>{{head}}</td>
        {% end %}
      </tr>
    </thead>
    <tbody>
    </tbody>
    </table>
  </div>
</div>
{% end %}
